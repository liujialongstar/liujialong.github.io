<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liujialongstar.github.io","root":"/","scheme":"Gemini","version":"8.0.0-rc.3","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="二叉查找树再最坏的情况下, 性能依然很糟糕. 因此我们需要一种能够保证无论如何构造, 运行时间都是对数级别的二叉查找树. 理想情况下, 一颗含有N个结点的书中, 我们希望树高是~lgN, 这样就能够保证所有查找都在~lgN次比较内结束, 就像二分查找一样. 但是在动态插入中保证这种完美平衡代价太高.  接下来, 我们将构造两种平衡树, 这些平衡树能够保证符号表API中所有操作(范围查找除外)均能在">
<meta property="og:type" content="article">
<meta property="og:title" content="平衡查找树">
<meta property="og:url" content="https://liujialongstar.github.io/2021/07/28/%E5%B9%B3%E8%A1%A1%E6%9F%A5%E6%89%BE%E6%A0%91/index.html">
<meta property="og:site_name" content="Longlong">
<meta property="og:description" content="二叉查找树再最坏的情况下, 性能依然很糟糕. 因此我们需要一种能够保证无论如何构造, 运行时间都是对数级别的二叉查找树. 理想情况下, 一颗含有N个结点的书中, 我们希望树高是~lgN, 这样就能够保证所有查找都在~lgN次比较内结束, 就像二分查找一样. 但是在动态插入中保证这种完美平衡代价太高.  接下来, 我们将构造两种平衡树, 这些平衡树能够保证符号表API中所有操作(范围查找除外)均能在">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://liujialongstar.github.io/img/algorithm/rb23tree.png">
<meta property="og:image" content="https://liujialongstar.github.io/img/algorithm/insertinto23node.png">
<meta property="article:published_time" content="2021-07-28T10:41:09.000Z">
<meta property="article:modified_time" content="2021-11-24T04:05:44.345Z">
<meta property="article:author" content="Liujialong">
<meta property="article:tag" content="算法">
<meta property="article:tag" content="符号表">
<meta property="article:tag" content="字典">
<meta property="article:tag" content="查找">
<meta property="article:tag" content="二叉查找树">
<meta property="article:tag" content="平衡查找树">
<meta property="article:tag" content="2-3查找树">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://liujialongstar.github.io/img/algorithm/rb23tree.png">

<link rel="canonical" href="https://liujialongstar.github.io/2021/07/28/%E5%B9%B3%E8%A1%A1%E6%9F%A5%E6%89%BE%E6%A0%91/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>平衡查找树 | Longlong</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Longlong</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A Rookie Programmer</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3查找树"><span class="nav-number">1.</span> <span class="nav-text">2-3查找树</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查找"><span class="nav-number">1.1.</span> <span class="nav-text">查找</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#插入"><span class="nav-number">1.2.</span> <span class="nav-text">插入</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#向2-结点中插入新键"><span class="nav-number">1.2.1.</span> <span class="nav-text">向2-结点中插入新键</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#向3-结点中插入新键"><span class="nav-number">1.2.2.</span> <span class="nav-text">向3-结点中插入新键</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#向一棵只含有一个3-结点的树中插入新键"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">向一棵只含有一个3-结点的树中插入新键</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#向一个父结点为2-结点的3-结点中插入新键"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">向一个父结点为2-结点的3-结点中插入新键</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#向一个父结点为3-结点的3-结点中插入新键"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">向一个父结点为3-结点的3-结点中插入新键</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#分解根结点"><span class="nav-number">1.2.2.4.</span> <span class="nav-text">分解根结点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#局部变换"><span class="nav-number">1.3.</span> <span class="nav-text">局部变换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#全局性质"><span class="nav-number">1.4.</span> <span class="nav-text">全局性质</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分析"><span class="nav-number">1.5.</span> <span class="nav-text">分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#红黑二叉查找树"><span class="nav-number">2.</span> <span class="nav-text">红黑二叉查找树</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定义"><span class="nav-number">2.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一种等价的定义"><span class="nav-number">2.2.</span> <span class="nav-text">一种等价的定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#与2-3树的对应关系"><span class="nav-number">2.3.</span> <span class="nav-text">与2-3树的对应关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#颜色表示"><span class="nav-number">2.4.</span> <span class="nav-text">颜色表示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#旋转"><span class="nav-number">2.5.</span> <span class="nav-text">旋转</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#旋转后重置父结点的链接"><span class="nav-number">2.6.</span> <span class="nav-text">旋转后重置父结点的链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#插入-1"><span class="nav-number">2.7.</span> <span class="nav-text">插入</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#向2-节点插入新键"><span class="nav-number">2.7.1.</span> <span class="nav-text">向2-节点插入新键</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#向树底的2-结点插入新键"><span class="nav-number">2.7.2.</span> <span class="nav-text">向树底的2-结点插入新键</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#向一棵双键树-即一个3-结点-插入新键"><span class="nav-number">2.7.3.</span> <span class="nav-text">向一棵双键树(即一个3-结点)插入新键</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#颜色转换"><span class="nav-number">2.7.4.</span> <span class="nav-text">颜色转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#根结点总是黑色"><span class="nav-number">2.7.5.</span> <span class="nav-text">根结点总是黑色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#向树底部的3结点插入新键"><span class="nav-number">2.7.6.</span> <span class="nav-text">向树底部的3结点插入新键</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#将红链接在树中向上传递"><span class="nav-number">2.7.7.</span> <span class="nav-text">将红链接在树中向上传递</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现"><span class="nav-number">2.7.8.</span> <span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除操作"><span class="nav-number">2.8.</span> <span class="nav-text">删除操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#自顶向下的2-3-4树"><span class="nav-number">2.8.1.</span> <span class="nav-text">自顶向下的2-3-4树</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除最小键"><span class="nav-number">2.8.2.</span> <span class="nav-text">删除最小键</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除操作-1"><span class="nav-number">2.8.3.</span> <span class="nav-text">删除操作</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Liujialong</p>
  <div class="site-description" itemprop="description">My records for programming and life</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content post posts-expand">
          

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liujialongstar.github.io/2021/07/28/%E5%B9%B3%E8%A1%A1%E6%9F%A5%E6%89%BE%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Liujialong">
      <meta itemprop="description" content="My records for programming and life">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Longlong">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          平衡查找树
        </h1>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-28 18:41:09" itemprop="dateCreated datePublished" datetime="2021-07-28T18:41:09+08:00">2021-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-24 12:05:44" itemprop="dateModified" datetime="2021-11-24T12:05:44+08:00">2021-11-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>二叉查找树再最坏的情况下, 性能依然很糟糕. 因此我们需要一种能够保证无论如何构造, 运行时间都是对数级别的二叉查找树. 理想情况下, 一颗含有N个结点的书中, 我们希望树高是<strong>~lgN</strong>, 这样就能够保证所有查找都在<strong>~lgN</strong>次比较内结束, 就像二分查找一样. 但是在动态插入中保证这种完美平衡代价太高. </p>
<p>接下来, 我们将构造两种平衡树, 这些平衡树能够保证符号表API中所有操作(范围查找除外)均能在对数时间内完成.</p>
<a id="more"></a>

<h2 id="2-3查找树"><a href="#2-3查找树" class="headerlink" title="2-3查找树"></a>2-3查找树</h2><p>一棵标准的二叉查找树中的结点被称为2-结点(含有一个键和两条链接), 现在我们引入3-结点, 它含有两个键和三条链接. 2-结点和3-结点中的每条链接都对应着其中保存的键所分割产生的一个区间.</p>
<blockquote>
<p>定义: 一棵2-3查找树, 或者是一条空树, 或者由以下结点组成</p>
<ul>
<li>2-结点, 含有一个键(及其对应值)和两条链接, 左链接指向的2-3树中的键都小于该节点, 右链接指向的2-3树中的键都大于该节点.</li>
<li>3-结点, 含有两个键(及其对应值)和三条链接, 左链接指向的2-3树中的键都小于该节点, 中链接指向的2-3树中的键都位于该节点的两个键之间, 右链接指向的2-3树的键都大于该节点.</li>
</ul>
</blockquote>
<p>一棵完美平衡的2-3查找树中所有空链接到根结点的距离都应该是相同的.</p>
<h3 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h3><p>要判断一个键是否在书中, 需要先将它和根结点中的键比较. 如果它和其中任意一个相等, 查找命中; 否则就根据比较结果找到指向相应区间的链接, 并在其指向的子树中递归地继续查找. 如果这是个空链接, 查找未命中.</p>
<h3 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h3><h4 id="向2-结点中插入新键"><a href="#向2-结点中插入新键" class="headerlink" title="向2-结点中插入新键"></a>向2-结点中插入新键</h4><p>要在2-3树中插入一个新结点, 可以和二叉树一样先进行一次未命中地查找, 然后把新节点挂在树的底部. 但是这样的话, 树就无法保证完美平衡性. 如果未命中的查找结束于一个2-结点, 那么只要把这个2-结点替换为一个3-结点, 将要插入的键保存在其中即可.</p>
<h4 id="向3-结点中插入新键"><a href="#向3-结点中插入新键" class="headerlink" title="向3-结点中插入新键"></a>向3-结点中插入新键</h4><h5 id="向一棵只含有一个3-结点的树中插入新键"><a href="#向一棵只含有一个3-结点的树中插入新键" class="headerlink" title="向一棵只含有一个3-结点的树中插入新键"></a>向一棵只含有一个3-结点的树中插入新键</h5><p>在考虑一般情况之前, 先假设需要向一棵只含有一个3-结点的树中插入一个新键. 这棵树中有两个键, 唯一的结点中已经没有插入新键的空间. 为了将新键插入, 需要先临时将新键插入该节点中, 使之成为一个4-结点(包含3个键和4个链接). 一个4-结点可以很方便的转换为一棵由3个2-结点组成的2-3树, 新树中, 根结点含有原4-结点的中键, 左子结点含有原4-结点中的最小键, 右子结点含有原4-结点中的最大键. 这棵树既是一棵含有3个结点的二叉查找树, 也是一棵完美平衡的2-3树, 因为其中所有的空连接到根结点的距离都相等. 插入前树高为0, 插入后树高为1. 这个例子说明了, 2-3树是向上生长的(普通的二叉树是向下生长的).</p>
<h5 id="向一个父结点为2-结点的3-结点中插入新键"><a href="#向一个父结点为2-结点的3-结点中插入新键" class="headerlink" title="向一个父结点为2-结点的3-结点中插入新键"></a>向一个父结点为2-结点的3-结点中插入新键</h5><p>假设未命中的查找结束于一个3-结点, 而它的父结点是一个2-结点. 在这种情况下, 需要<strong>在维持树的完美平衡的前提下为新键腾出空间</strong>. 我们可以像上节中一样构造一个临时的4-结点并将其分解, 但此时不会为中键创建一个新结点, 而是将其移动到原来的父结点中. 父结点作为一个2-结点, 是有空间接纳一个新键的, 插入新键之后将变为一个3-结点. 可以将这次转换看成将指向原3-结点的一条链接替换成新父结点中的原中键左右两边的两条链接, 并分别指向两个新的2-结点. </p>
<p>这次转换并不影响2-3树的主要性质: 树仍然是有序的, 因为中键被移动到父结点中去了; 树仍然是完美平衡的, 插入后的所有空链接到根结点的距离仍然相同.</p>
<h5 id="向一个父结点为3-结点的3-结点中插入新键"><a href="#向一个父结点为3-结点的3-结点中插入新键" class="headerlink" title="向一个父结点为3-结点的3-结点中插入新键"></a>向一个父结点为3-结点的3-结点中插入新键</h5><p>假设未命中的查找结束于一个父结点为3-结点的3-结点. 我们再次构造一个临时的4-结点并分解它, 然后将它的中键插入它的父结点中. 但父结点也是一个3-结点, 一次我们再用这个中键为父结点构造一个临时的4-结点, 然后在这个结点上进行<strong>相同的变换</strong>, 即分解这个父结点并将它的中键插入到它的父结点中. 推广到一般的情况, 我们就这样一直向上不断分解临时的4-结点并将中键插入更高层的父结点, 直到遇到一个2-结点并将它替换为一个不需要继续分解的3-结点, 或是达到3-结点的根.</p>
<h5 id="分解根结点"><a href="#分解根结点" class="headerlink" title="分解根结点"></a>分解根结点</h5><p>如果从插入结点到根结点的路径上都是3-结点, 整棵树的根结点将变成一个临时4-结点. 此时可以按照向一棵只有一个3-结点的树中插入新键的方法处理这个问题, 将临时的4-结点分解成3个2-结点, 使树高增加1. 这次变换后仍然保持了树的完美平衡性, 因为变换的是根结点. 从这里也可以看出, 2-3树是向上生长的.</p>
<h3 id="局部变换"><a href="#局部变换" class="headerlink" title="局部变换"></a>局部变换</h3><p>将一个4-结点分解成一棵2-3树可能有6种情况: 这个4-结点可能是根结点, 可能是一个2-结点的左子结点或右子节点, 可能是一个3-结点的左子结点/中子结点/右子节点. 2-3树插入算法的根本在于这些变换都是局部的: 除了相关的结点和链接之外不必修改或检查树的其他部分. 每次变换中, 变更的链接数量不会超过一个很小的常数. 需要特别指出的是, 不光是在树的底部, 书中的<strong>任何地方</strong>只要符合相应的模式, 变换都可以进行. 每个变换都会将4-结点中的一个键送入它的父结点中, 并重构相应的链接而不必涉及树的其他部分.</p>
<h3 id="全局性质"><a href="#全局性质" class="headerlink" title="全局性质"></a>全局性质</h3><p>这些局部变换不会影响树的全局有序性和平衡性: 任意空链接到根结点的路径长度都是相等的.</p>
<p>和标准二叉查找树由上向下生长不通, 2-3树的生长是由下向上的. </p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>一棵含有N个结点的2-3树的高度在(lgN/lg3)(如果树中全是3-结点)和(lgN)(如果树中全是2-结点)之间, 因此, 在一棵大小为N的2-3树中, 查找和插入操作访问的结点必然不超过lgN个. </p>
<p>因此我们可以确定2-3树在最坏情况下让然有较好的性能. 每个操作中处理每个结点的时间都不会超过一个很小的常数, 且这两个操作都只会访问一条路径上的结点, 所以任何查找或者插入的成本都肯定不会超过对数级别. 例如含有10亿个结点的一棵2-3树的高度仅在19到30之间. 我们最多访问30个结点就能在10亿个键进行任意查找和插入操作.</p>
<p>尽管可以使用不同的数据类型表示2-结点和3-结点并写出变换所需的代码, 但由于需要处理的情况太多, 这样实现2-3树并不方便. 我们需要维护两种不同类型的结点(可能是4种, 因为还需要使用4-结点做中间态转换), 将被查找的键和节点中的每个键进行比较, 将链接和其他信息从一种结点复制到另一种结点, 将结点从一种数据类型转换到另一种数据类型, 等等. 实现这些不仅需要大量的代码, 而且他们所产生的额外开销可能使算法比标准的二叉查找树更慢. </p>
<p>平衡一棵树的初衷是消除最坏的情况, 但是我们希望这种保障所需要的代码越少越好. 接下来我们将付出一点点代价使用一种统一的方式完成所有变换.</p>
<h2 id="红黑二叉查找树"><a href="#红黑二叉查找树" class="headerlink" title="红黑二叉查找树"></a>红黑二叉查找树</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>红黑二叉查找树是2-3树的一种变体. 红黑二叉查找树的基本思想是用标准的二叉查找树(完全由2-结点构成)和一些额外的信息(替换3-结点)来表示2-3树. </p>
<p>我们将树中的链接分为两种类型:</p>
<ul>
<li><strong>红链接</strong>, 用于将两个2-结点连接起来构成一个3-结点;</li>
<li><strong>黑链接</strong>, 2-3树中的普通链接.</li>
</ul>
<p>在红黑树中, 我们将2-3树中的3-结点表示为一条由<strong>左斜</strong>的红色链接(两个2-结点其中之一是另一个的左子结点)相连的两个2-结点. 使用这种表示方法, 我们可以直接使用标准二叉查找树的get()方法. 对于任意2-3树, 只需要对结点进行转换, 就可以立即派生出一棵对应的红黑二叉查找树. </p>
<h3 id="一种等价的定义"><a href="#一种等价的定义" class="headerlink" title="一种等价的定义"></a>一种等价的定义</h3><p><strong>红黑树</strong>是含有红黑链接并满足一下条件的二叉查找树:</p>
<ul>
<li>红链接均为左链接;</li>
<li>没有任何一个结点同时和两条红链接相连;</li>
<li>该树是<strong>完美黑色平衡</strong>的, 即任意空链接到根结点的路径上的黑链接的数量相同. </li>
</ul>
<h3 id="与2-3树的对应关系"><a href="#与2-3树的对应关系" class="headerlink" title="与2-3树的对应关系"></a>与2-3树的对应关系</h3><p>如果将一棵红黑树中的红链接画平, 那么所有的空链接到根结点的距离都是相同的. 如果将由红链接相连的结点合并, 就会的带一棵2-3树. 相反, 如果将一棵2-3树中的3-结点画作由红色左链接相连的两个2-结点, 那么就不会存在能能够和两个红链接相连的结点, 且树必然是完美黑色平衡的, 因为黑链接即2-3树中的普通链接, 根据定义这些链接必然是完美平衡的. </p>
<p>无论选择那种方式定义, 红黑树都既是二叉查找树, 也是2-3树. 因此, 我们可以在保持一一对应关系的基础上实现2-3树的插入算法, 并将两种算法的有点结合起来: 二叉查找树中高效的查找算法和2-3树中高效的平衡插入算法.</p>
<p>红黑树和2-3树的关系如下图:</p>
<p><img src="/img/algorithm/rb23tree.png" alt="红黑树和2-3树的对应关系"></p>
<h3 id="颜色表示"><a href="#颜色表示" class="headerlink" title="颜色表示"></a>颜色表示</h3><p>以为每个结点只有一条指向自己的链接(从它的父结点指向它), 我们将链接的颜色保存在表示结点的Node数据类型的布尔变量color中. 如果指向它的链接是红色的, 那么该变量为true, 黑色则为false. 空链接为黑色. 为了代码清晰, 我们定义两个常量RED和BLACK来设置和测试这个变量, 并使用私有方法isRed()来测试一个结点和它的父结点之间的链接的颜色. 当提到一个结点的颜色时, 指的是指向该结点的链接的颜色. </p>
<p>颜色表示的代码实现如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> K key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> V val;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 左链接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BinarySearchTree.Node left;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 右链接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BinarySearchTree.Node right;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计数器, 以该节点为根的子树的结点总数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> N;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 由其父结点指向它的链接的颜色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> color;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(K key, V val, <span class="keyword">int</span> N, <span class="keyword">boolean</span> color)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.val = val;</span><br><span class="line">        <span class="keyword">this</span>.N = N;</span><br><span class="line">        <span class="keyword">this</span>.color = color;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> RED = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> BLACK = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isRed</span><span class="params">(Node x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> x.color == RED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="旋转"><a href="#旋转" class="headerlink" title="旋转"></a>旋转</h3><p>旋转操作会改变红链接的指向, 用以修复某些操作中可能出现的红色右链接或者两条连续的红链接(一个结点同时和两条红链接相连). </p>
<p>将一条红色的右链接转化成左链接的操作, 叫做<strong>左旋转</strong>, 它对应的方法接受一条指向红黑树中某个结点的链接作为参数. 假设被指向的节点的右链接是红色的, 这个方法会对树进行必要的调整并返回一个指向包含同一组键的子树且其左链接为红色的根节点的链接. 这段描述略微拗口, 实际上就是将红链接指向的两个键中以较小键作为根节点变为以较大者作为根节点. 实现将一个红色左链接转换为一个红色右链接的<strong>右旋转</strong>操作代码完全相同, 只需要将left换成right即可.</p>
<p><strong>左旋转</strong>和<strong>右旋转</strong>代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 左旋转, 将红色右链接变换为红色左链接</span></span><br><span class="line"><span class="comment"> * 将结点h右链接提取为x, 节点x的左链接指向的节点链接到节点h的右链接, 节点x的左链接指向节点h, 转换完成</span></span><br><span class="line"><span class="comment"> * 重置节点颜色, 重置节点大小</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> h</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">rotateLeft</span><span class="params">(Node h)</span> </span>&#123;</span><br><span class="line">    Node x = h.right;</span><br><span class="line">    h.right = x.left;</span><br><span class="line">    x.left = h;</span><br><span class="line">    x.color = h.color;</span><br><span class="line">    h.color = RED;</span><br><span class="line">    x.N = h.N;</span><br><span class="line">    h.N = <span class="number">1</span> + size(h.left) + size(h.right);</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 右旋转, 左旋转的逆操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> h</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">rotateRight</span><span class="params">(Node h)</span> </span>&#123;</span><br><span class="line">    Node x = h.left;</span><br><span class="line">    h.left = x.right;</span><br><span class="line">    x.right = h;</span><br><span class="line">    x.color = h.color;</span><br><span class="line">    h.color = RED;</span><br><span class="line">    x.N = h.N;</span><br><span class="line">    h.N = <span class="number">1</span> + size(h.left) + size(h.right);</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="旋转后重置父结点的链接"><a href="#旋转后重置父结点的链接" class="headerlink" title="旋转后重置父结点的链接"></a>旋转后重置父结点的链接</h3><p>旋转操作会返回一条链接. 这条链接将替换父结点中原本的链接, 并且保留链接原本的颜色. 这可能会产生两条连续的红链接, 但我们会继续用旋转操作修正这种情况. </p>
<p>在插入新的键时, 我们可以使用旋转操作保证2-3树和红黑树之间的一一对应关系, 因为旋转操作可以保证红黑树的两个重要性质: <strong>有序性</strong>和<strong>完美平衡性</strong>. 接下来我们将看到如何使用旋转操作来保证插入操作红黑树的另外两条性质: 不存在两条连续的红链接和不存在红色的右链接.</p>
<h3 id="插入-1"><a href="#插入-1" class="headerlink" title="插入"></a>插入</h3><blockquote>
<p>插入的一定是红色结点</p>
</blockquote>
<h4 id="向2-节点插入新键"><a href="#向2-节点插入新键" class="headerlink" title="向2-节点插入新键"></a>向2-节点插入新键</h4><p>一棵只含有一个键的红黑树只含有一个2-结点. 插入一个键后, 如果新键小于老键, 我们只需要新增一个红色的结点即可, 新的红黑树和单个3-结点完全等价. 如果新键大于老键, 那么新增的红色结点将会产生一条红色的右链接, 我们需要使用root = rotateLeft(root), 来将其旋转为红色左链接并修正根结点的链接, 插入才算完成. 两种情况的结果均为一棵和单个3-结点等价的红黑树, 其中含有两个键, 一条红链接, 树的黑链接高度为1.</p>
<h4 id="向树底的2-结点插入新键"><a href="#向树底的2-结点插入新键" class="headerlink" title="向树底的2-结点插入新键"></a>向树底的2-结点插入新键</h4><p>为了保证有序性, 向红黑树中插入一个新键会在树的底部新增一个结点, 但总是用红链接将新结点和它的父结点连接(即插入的总是一个红色结点). 如果它的结点是一个2-结点, 则适用上节讨论的情形: 如果指向新结点的是父结点的左链接, 那么父结点直接成为一个3-结点; 如果指向新结点的是父结点的右链接, 这就是一个错误的3-结点, 需要通过一次右旋转来修正它.</p>
<h4 id="向一棵双键树-即一个3-结点-插入新键"><a href="#向一棵双键树-即一个3-结点-插入新键" class="headerlink" title="向一棵双键树(即一个3-结点)插入新键"></a>向一棵双键树(即一个3-结点)插入新键</h4><p>这种情况可以分为3种子情况: 新键小于树中的两个键, 在两者之间, 或是大于树中的两个键. 每种情况都会产生一个同时连接到两条红链接的结点, 我们的目标就是修正这一点.</p>
<ul>
<li>最简单的情况是新键<em>大于</em>原树中的键, 那么它将被连接到3-结点的右链接. 此时树是平衡的, 根节点为中间大小的键, 它的左右链接均为红色链接. 如果我们将两条链接的颜色都由红变黑, 那么我们就得到了一棵由三个结点组成, 高度为2的平衡树, 正好对应一棵2-3树. </li>
<li>如果新键<em>小于</em>原树的两个键, 它会被连接到最左边的空链接, 这样就产生了两条连续的红链接, 此时只需要将上层的红色链接右旋转即可的到第一种情况, 接着转换为一棵平衡树.</li>
<li>如果新键介于原树中的两个键<em>之间</em>, 这又会产生两条连续的红链接, 一条红色的左链接接一条红色的右链接, 此时只需要将下层的红链接做旋转即可的到第二种情况, 接着转换为一棵平衡树.</li>
</ul>
<p>三种情况如下图所示:</p>
<p><img src="/img/algorithm/insertinto23node.png" alt="向一棵双键树插入一个新键"></p>
<p>综上, 我们通过0次, 1次和2次旋转以及颜色的变化得到了期望的结果.</p>
<h4 id="颜色转换"><a href="#颜色转换" class="headerlink" title="颜色转换"></a>颜色转换</h4><p>我们创建一个方法flipColors()来转换一个结点的两个红色子结点的颜色. 除了将子结点的颜色由红变黑外, 同时还要将父结点的颜色由黑变红. 这项操作和旋转操作一样是局部变换, 不会影响整棵树的黑色平衡性.</p>
<p>颜色转换代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">flipColors</span><span class="params">(Node h)</span> </span>&#123;</span><br><span class="line">    h.color = RED;</span><br><span class="line">    h.left.color = BLACK;</span><br><span class="line">    h.right.color = BLACK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="根结点总是黑色"><a href="#根结点总是黑色" class="headerlink" title="根结点总是黑色"></a>根结点总是黑色</h4><p>颜色转换会使根结点变为红色. 因此我们再每次插入后都会将根结点设为黑色. 每当根结点由红变黑时, 树的黑色连接高度就会加1.</p>
<h4 id="向树底部的3结点插入新键"><a href="#向树底部的3结点插入新键" class="headerlink" title="向树底部的3结点插入新键"></a>向树底部的3结点插入新键</h4><p>假设向树的底部的一个3-结点下加入一个新结点, 前面讨论的三种情况都会出现, 颜色转换后都会使终结点的连接变红, 相当于将它送入父结点, 相当于在父结点中插入一个新键, 然后继续用相同的方法解决这个问题(递归)</p>
<h4 id="将红链接在树中向上传递"><a href="#将红链接在树中向上传递" class="headerlink" title="将红链接在树中向上传递"></a>将红链接在树中向上传递</h4><p>2-3树中的插入算法需要分解3-结点, 将中间键插入父结点, 如此直到遇到一个2-结点或根结点. 在红黑树中, 每次必要的旋转之后都会进行颜色转换, 这使得中结点变红. 对于父结点, 这相当于插入一个新的红色结点, 这就需要继续把红链接转移到中结点上. </p>
<p>总之, 只要谨慎地使用左旋转, 右旋转和颜色转换这三种简单地操作, 就能保证插入操作之后红黑树和2-3树地一一对应关系. </p>
<p>在沿着插入点到根结点的路径向上移动时, 在所经过的每个结点中顺序完成以下操作, 就能完成插入操作:</p>
<ul>
<li>如果右子节点是红色的而左子结点是黑色的, 进行左旋转;</li>
<li>如果左子结点是红色的且它的左子结点也是红色的, 进行右旋转;</li>
<li>如果左右子结点均为红色, 进行颜色转换.</li>
</ul>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(K key, V val)</span> </span>&#123;</span><br><span class="line">    put(root, key, val);</span><br><span class="line">    root.color = BLACK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">put</span><span class="params">(Node h, K key, V val)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(h == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Node(key, val, <span class="number">1</span>, RED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> cmp = key.compareTo(h.key);</span><br><span class="line">    <span class="keyword">if</span>(cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        h.left = put(h.left, key, val);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        h.right = put(h.right, key, val);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        h.val = val;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(isRed(h.right) &amp;&amp; !isRed(h.left))&#123;</span><br><span class="line">        h = rotateLeft(h);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(isRed(h.left) &amp;&amp; isRed(h.left.left))&#123;</span><br><span class="line">        h = rotateRight(h);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(isRed(h.left) &amp;&amp; isRed(h.right)) &#123;</span><br><span class="line">        flipColors(h);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    h.N = <span class="number">1</span> + size(h.left) + size(h.right);</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了递归调用后的三条if语句, 红黑树中的put()的递归实现和二叉查找树中put()的实现完全相同. 三条if语句会保证在查找路径上红黑树和2-3树一一对应, 使得树的平衡性接近完美. </p>
<h3 id="删除操作"><a href="#删除操作" class="headerlink" title="删除操作"></a>删除操作</h3><p>和插入操作一样, 我们也可以定义一系列局部变换来在删除一个结点的同时保持树的完美平衡性. 这个过程比插入一个结点更加复杂, 因为我们不仅要在(为了删除一个结点而)构造临时4-结点时<strong>沿着查找路径向下</strong>进行变换, 还要在分解遗留的4-结点时<strong>沿着查找路径向上</strong>进行变换(同插入操作).</p>
<h4 id="自顶向下的2-3-4树"><a href="#自顶向下的2-3-4树" class="headerlink" title="自顶向下的2-3-4树"></a>自顶向下的2-3-4树</h4><p>我们先学习一个沿着查找路径既能向上也能向下进行变换的算法: 2-3-4树的插入算法, 2-3-4树中允许存在4-结点. </p>
<p>它的插入算法沿着查找路径向下变换是为了保证当前结点不是4-结点(这样树底才有空间来插入新的键), 沿着查找路径向上进行变换是为了将之前创建的4-结点配平. </p>
<p>向下的变换和2-3树中分解4-结点所进行的变换完全相同. 如果根结点是4-接待你, 就将它分解成三个2-结点, 使得树高加1. 向下查找的过程中, 如果遇到一个父结点为2-结点的4-接待你, 就将4-结点分解为两个2-结点并将中间键传递给它的父结点, 使父结点变为一个3-结点; 如果遇到一个父结点为3-结点的4-结点, 我们将4-结点分解为两个2-结点并将中间键传递给它的父结点, 使父结点变为一个4-结点; 不会遇到父结点为4-结点的4-结点, 因为算法本身就保证了这种情况不会出现. 到达树的底部之后, 只会遇到2-结点或者3-结点, 这样就可以插入新的键.</p>
<p>要用红黑树实现这个算法, 需要以下操作:</p>
<ul>
<li>将4-结点表示为由三个2-结点组成的一棵平衡树的子树, 根结点和两个子节点都用红链接相连;</li>
<li>在向下的过程中分解所有4-结点并进行颜色转换;</li>
<li>和插入一样, 在向上的过程中用旋转将4-结点配平</li>
</ul>
<h4 id="删除最小键"><a href="#删除最小键" class="headerlink" title="删除最小键"></a>删除最小键</h4><p>从树的底部的3-结点中删除键很简单, 但是对于2-结点, 删除一个键会留下一个空结点, 如果将它替换成一个空链接, 会破坏树的平衡性.</p>
<p>为了保证我们不会删除一个2-结点, 我们沿着左链接向下进行变换, 确保当前结点不是2-结点(可能是3-结点, 可能是临时的4-结点). 首先, 根节点可能有两种情况. 如果根是2-结点且它的两个子结点都是2-结点, 我们可以直接将这三个结点变成一个4-结点; 否则我们需要确保根节点的左子结点不是2-结点, 如有必要可以从它的右侧的兄弟结点借一个键过来. </p>
<p>在沿着左链接向下的过程中, 保证一下情况之一成立:</p>
<ul>
<li>如果当前结点的左子结点不是2-结点, 完成;</li>
<li>如果当前结点的左子结点是2-结点而他的兄弟结点不是2-结点, 将左子结点的兄弟结点中的一个键移动到左子结点;</li>
<li>如果当前结点的左子结点和他的兄弟结点都是2-结点, 将左子结点, 父结点中的最小键和左子结点最近的兄弟结点合并成一个4-结点, 使父结点有3-结点变成2-结点或者有4-结点变成3-结点.</li>
</ul>
<p>在遍历的过程中执行这个过程, 最后能够得到一个含有最小键的3-结点或4-结点, 然后就可以从中删除最小键, 然后再回头向上分解所有临时的4-结点.</p>
<h4 id="删除操作-1"><a href="#删除操作-1" class="headerlink" title="删除操作"></a>删除操作</h4><p>在查找路径上进行和删除最小键相同的变换同样可以保证在查找过程中任意当前结点均不是2-结点. 如果被查找的键在树的底部, 我们可以直接删除它. 如果不在, 我们需要将它和它的后继结点交换, 就和二叉查找树一样. 因为当前结点必然不是一个2-结点, 问题就转化为在一棵根节点不是2-结点的子树中删除最小键, 我们可以使用上节的算法. 删除之后需要向上回溯并分解余下的4结点.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>所有基于红黑树的符号表实现都能保证操作的运行时间为对数级别(范围查找除外, 它所需的额外时间和返回的键的数量成正比).</p>
<p>一棵大小为N的红黑树的高度不会超过2lgN.</p>
<p>一棵大小为N的红黑树中, 根结点到任意结点的平均路径长度为~lgN.</p>
<p>红黑树最吸引人的一点在于它的实现中最复杂的代码仅限于put()和delete()方法. 二叉查找树中的select(), rank(), floor(), ceiling()和范围查找方法可以不做任何改动继续使用, 因为红黑树也是二叉查找树, 而这些操作不会涉及到结点的颜色. </p>
<p>最后, 红黑树完整的实现代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liujialong</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/8/5</span></span><br><span class="line"><span class="comment"> * 红黑树</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedBlackBinarySearchTree</span>&lt;<span class="title">K</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">K</span>&gt;, <span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">OrderedSymbolTable</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> RED = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> BLACK = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将键值对存放再表中(若值为空则将键key从表中删除)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> val</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(K key, V val)</span> </span>&#123;</span><br><span class="line">        root = put(root, key, val);</span><br><span class="line">        root.color = BLACK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">put</span><span class="params">(Node h, K key, V val)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(h == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Node(key, val, <span class="number">1</span>, RED);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> cmp = key.compareTo(h.key);</span><br><span class="line">        <span class="keyword">if</span>(cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            h.left = put(h.left, key, val);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            h.right = put(h.right, key, val);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            h.val = val;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(isRed(h.right) &amp;&amp; !isRed(h.left))&#123;</span><br><span class="line">            h = rotateLeft(h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(isRed(h.left) &amp;&amp; isRed(h.left.left))&#123;</span><br><span class="line">            h = rotateRight(h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(isRed(h.left) &amp;&amp; isRed(h.right)) &#123;</span><br><span class="line">            flipColors(h);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        h.N = <span class="number">1</span> + size(h.left) + size(h.right);</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取键key对应的值(若键key不存在则返回null)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(K key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> get(root, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> V <span class="title">get</span><span class="params">(Node x, K key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(x == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> cmp = key.compareTo(x.key);</span><br><span class="line">        <span class="keyword">if</span>(cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> get(x.left, key);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> get(x.right, key);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> x.val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从表中删除键key及其对应的值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(K key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!contains(key))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isRed(root.left) &amp;&amp; !isRed(root.right))</span><br><span class="line">            root.color = RED;</span><br><span class="line"></span><br><span class="line">        root = delete(root, key);</span><br><span class="line">        <span class="keyword">if</span> (!isEmpty()) root.color = BLACK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">delete</span><span class="params">(Node h, K key)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// assert get(h, key) != null;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (key.compareTo(h.key) &lt; <span class="number">0</span>)  &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isRed(h.left) &amp;&amp; !isRed(h.left.left))</span><br><span class="line">                h = moveRedLeft(h);</span><br><span class="line">            h.left = delete(h.left, key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isRed(h.left))</span><br><span class="line">                h = rotateRight(h);</span><br><span class="line">            <span class="keyword">if</span> (key.compareTo(h.key) == <span class="number">0</span> &amp;&amp; (h.right == <span class="keyword">null</span>))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (!isRed(h.right) &amp;&amp; !isRed(h.right.left))</span><br><span class="line">                h = moveRedRight(h);</span><br><span class="line">            <span class="keyword">if</span> (key.compareTo(h.key) == <span class="number">0</span>) &#123;</span><br><span class="line">                Node x = min(h.right);</span><br><span class="line">                h.key = x.key;</span><br><span class="line">                h.val = x.val;</span><br><span class="line">                h.right = deleteMin(h.right);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> h.right = delete(h.right, key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> balance(h);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 键key再表中是否存在对应的值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(K key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> get(key) != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表是否为空</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> root == <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表中键值对的数量</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> size(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">(Node x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x.N;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最小的键</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> K <span class="title">min</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> min(root).key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">min</span><span class="params">(Node x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(x.left == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> min(x.left);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最大的键</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> K <span class="title">max</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> max(root).key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">max</span><span class="params">(Node x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(x.right == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> max(x.right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 小于等于key的最大键</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> K <span class="title">floor</span><span class="params">(K key)</span> </span>&#123;</span><br><span class="line">        Node x = floor(root, key);</span><br><span class="line">        <span class="keyword">if</span>(x == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">floor</span><span class="params">(Node x, K key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(x == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> cmp = key.compareTo(x.key);</span><br><span class="line">        <span class="keyword">if</span>(cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> floor(x.left, key);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Node t = floor(x.right, key);</span><br><span class="line">            <span class="keyword">if</span>(t != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> x;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 大于等于key的最小键</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> K <span class="title">ceiling</span><span class="params">(K key)</span> </span>&#123;</span><br><span class="line">        Node x = ceiling(root, key);</span><br><span class="line">        <span class="keyword">if</span>(x == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">ceiling</span><span class="params">(Node x, K key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(x == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> cmp = x.key.compareTo(key);</span><br><span class="line">        <span class="keyword">if</span>(cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ceiling(x.right, key);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Node t = ceiling(x.left, key);</span><br><span class="line">            <span class="keyword">if</span>(t != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> x;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 小于key的键的数量</span></span><br><span class="line"><span class="comment">     * 这里的1是根结点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">rank</span><span class="params">(K key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> rank(root, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">rank</span><span class="params">(Node x, K key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(x == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> cmp = key.compareTo(x.key);</span><br><span class="line">        <span class="keyword">if</span>(cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> rank(x.left, key);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span> + size(x.left) +rank(x.right, key);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> size(x.left);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排名为k的键</span></span><br><span class="line"><span class="comment">     * 这里的1是根结点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> k</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> K <span class="title">select</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> select(root , k);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> K <span class="title">select</span><span class="params">(Node x, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(x == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> t = size(x.left);</span><br><span class="line">        <span class="keyword">if</span>(t &gt; k) &#123;</span><br><span class="line">            <span class="keyword">return</span> select(x.left, k);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(t &lt; k) &#123;</span><br><span class="line">            <span class="keyword">return</span> select(x.right, k - t - <span class="number">1</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> x.key;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除最小的键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteMin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        root = deleteMin(root);</span><br><span class="line">        <span class="keyword">if</span>(!isEmpty()) &#123;</span><br><span class="line">            root.color = BLACK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">deleteMin</span><span class="params">(Node h)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (h.left == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isRed(h.left) &amp;&amp; !isRed(h.left.left)) &#123;</span><br><span class="line">            h = moveRedLeft(h);</span><br><span class="line">        &#125;</span><br><span class="line">        h.left = deleteMin(h.left);</span><br><span class="line">        <span class="keyword">return</span> balance(h);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除最大的键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteMax</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        root = deleteMax(root);</span><br><span class="line">        <span class="keyword">if</span>(!isEmpty()) &#123;</span><br><span class="line">            root.color = BLACK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">deleteMax</span><span class="params">(Node h)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(isRed(h.left)) &#123;</span><br><span class="line">            h = rotateRight(h);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(h.right == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!isRed(h.right) &amp;&amp; !isRed(h.right.left))&#123;</span><br><span class="line">            h = moveRedRight(h);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        h.right = deleteMax(h.right);</span><br><span class="line">        <span class="keyword">return</span> balance(h);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterable&lt;K&gt; <span class="title">keys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> keys(min(), max());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * [low..high]之间所有键的集合, 已排序</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> low</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> high</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterable&lt;K&gt; <span class="title">keys</span><span class="params">(K low, K high)</span> </span>&#123;</span><br><span class="line">        LinkedQueue&lt;K&gt; queue = <span class="keyword">new</span> LinkedQueue&lt;&gt;();</span><br><span class="line">        keys(root, queue, low, high);</span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">keys</span><span class="params">(Node x, LinkedQueue&lt;K&gt; queue, K low, K high)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(x == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> cmpLow = low.compareTo(x.key);</span><br><span class="line">        <span class="keyword">int</span> cmpHigh = high.compareTo(x.key);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 递归调用小于low的左子树</span></span><br><span class="line">        <span class="keyword">if</span>(cmpLow &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            keys(x.left, queue, low, high);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果当前结点落在low..high的范围内, 将当前节点的键压入队列</span></span><br><span class="line">        <span class="keyword">if</span>(cmpLow &lt;= <span class="number">0</span> &amp;&amp; cmpHigh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            queue.enqueue(x.key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 递归调用大于high的右子树</span></span><br><span class="line">        <span class="keyword">if</span>(cmpHigh &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            keys(x.right, queue, low, high);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">height</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> height(root);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">height</span><span class="params">(Node x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span>) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> + Math.max(height(x.left), height(x.right));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 键</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> K key;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 值</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> V val;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 左链接</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> Node left;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 右链接</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> Node right;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 计数器, 以该节点为根的子树的结点总数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> N;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 由其父结点指向它的链接的颜色</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> color;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(K key, V val, <span class="keyword">int</span> N, <span class="keyword">boolean</span> color)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.val = val;</span><br><span class="line">            <span class="keyword">this</span>.N = N;</span><br><span class="line">            <span class="keyword">this</span>.color = color;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isRed</span><span class="params">(Node x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(x == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x.color == RED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 左旋转, 将红色右链接变换为红色左链接</span></span><br><span class="line"><span class="comment">     * 将结点h右链接提取为x, 节点x的左链接指向的节点链接到节点h的右链接, 节点x的左链接指向节点h, 转换完成</span></span><br><span class="line"><span class="comment">     * 重置节点颜色, 重置节点大小</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> h</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">rotateLeft</span><span class="params">(Node h)</span> </span>&#123;</span><br><span class="line">        Node x = h.right;</span><br><span class="line">        h.right = x.left;</span><br><span class="line">        x.left = h;</span><br><span class="line">        x.color = h.color;</span><br><span class="line">        h.color = RED;</span><br><span class="line">        x.N = h.N;</span><br><span class="line">        h.N = <span class="number">1</span> + size(h.left) + size(h.right);</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 右旋转, 左旋转的逆操作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> h</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">rotateRight</span><span class="params">(Node h)</span> </span>&#123;</span><br><span class="line">        Node x = h.left;</span><br><span class="line">        h.left = x.right;</span><br><span class="line">        x.right = h;</span><br><span class="line">        x.color = h.color;</span><br><span class="line">        h.color = RED;</span><br><span class="line">        x.N = h.N;</span><br><span class="line">        h.N = <span class="number">1</span> + size(h.left) + size(h.right);</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 颜色转换</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> h</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">flipColors</span><span class="params">(Node h)</span> </span>&#123;</span><br><span class="line">        h.color = RED;</span><br><span class="line">        h.left.color = BLACK;</span><br><span class="line">        h.right.color = BLACK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">moveRedLeft</span><span class="params">(Node h)</span> </span>&#123;</span><br><span class="line">        flipColors(h);</span><br><span class="line">        <span class="keyword">if</span> (isRed(h.right.left)) &#123;</span><br><span class="line">            h.right = rotateRight(h.right);</span><br><span class="line">            h = rotateLeft(h);</span><br><span class="line">            flipColors(h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">moveRedRight</span><span class="params">(Node h)</span> </span>&#123;</span><br><span class="line">        flipColors(h);</span><br><span class="line">        <span class="keyword">if</span> (isRed(h.left.left)) &#123;</span><br><span class="line">            h = rotateRight(h);</span><br><span class="line">            flipColors(h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">balance</span><span class="params">(Node h)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isRed(h.right) &amp;&amp; !isRed(h.left))    h = rotateLeft(h);</span><br><span class="line">        <span class="keyword">if</span> (isRed(h.left) &amp;&amp; isRed(h.left.left)) h = rotateRight(h);</span><br><span class="line">        <span class="keyword">if</span> (isRed(h.left) &amp;&amp; isRed(h.right))     flipColors(h);</span><br><span class="line"></span><br><span class="line">        h.N = size(h.left) + size(h.right) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String[] a = &#123;<span class="string">"q"</span>,<span class="string">"w"</span>,<span class="string">"e"</span>,<span class="string">"r"</span>,<span class="string">"t"</span>,<span class="string">"y"</span>,<span class="string">"u"</span>,<span class="string">"i"</span>,<span class="string">"o"</span>,<span class="string">"p"</span>,<span class="string">"a"</span>,<span class="string">"s"</span>,<span class="string">"d"</span>,<span class="string">"f"</span>,<span class="string">"g"</span>,<span class="string">"h"</span>,<span class="string">"j"</span>,<span class="string">"k"</span>,<span class="string">"l"</span>,<span class="string">"z"</span>,<span class="string">"x"</span>,<span class="string">"c"</span>,<span class="string">"v"</span>,<span class="string">"b"</span>,<span class="string">"n"</span>,<span class="string">"m"</span>&#125;;</span><br><span class="line">        RedBlackBinarySearchTree&lt;String, Integer&gt; st = <span class="keyword">new</span> RedBlackBinarySearchTree&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; a.length; i++) &#123;</span><br><span class="line">            String key = a[i];</span><br><span class="line">            st.put(key, i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(String s: st.keys())&#123;</span><br><span class="line">            System.out.println(s + <span class="string">": "</span> + st.get(s));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%AE%97%E6%B3%95/" rel="tag"># 算法</a>
              <a href="/tags/%E7%AC%A6%E5%8F%B7%E8%A1%A8/" rel="tag"># 符号表</a>
              <a href="/tags/%E5%AD%97%E5%85%B8/" rel="tag"># 字典</a>
              <a href="/tags/%E6%9F%A5%E6%89%BE/" rel="tag"># 查找</a>
              <a href="/tags/%E4%BA%8C%E5%8F%89%E6%9F%A5%E6%89%BE%E6%A0%91/" rel="tag"># 二叉查找树</a>
              <a href="/tags/%E5%B9%B3%E8%A1%A1%E6%9F%A5%E6%89%BE%E6%A0%91/" rel="tag"># 平衡查找树</a>
              <a href="/tags/2-3%E6%9F%A5%E6%89%BE%E6%A0%91/" rel="tag"># 2-3查找树</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/07/20/%E7%AC%A6%E5%8F%B7%E8%A1%A8%E7%9A%84%E4%BA%8C%E5%8F%89%E6%9F%A5%E6%89%BE%E6%A0%91%E5%AE%9E%E7%8E%B0/" rel="prev" title="符号表的二叉查找树实现">
      <i class="fa fa-chevron-left"></i> 符号表的二叉查找树实现
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/08/11/%E6%95%A3%E5%88%97%E8%A1%A8/" rel="next" title="散列表">
      散列表 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liujialong</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/next-boot.js"></script>


  















  

  

</body>
</html>
